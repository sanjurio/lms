{% extends "base.html" %}

{% block styles %}
<style>
/* ==========================
   COURSE DETAIL â€“ THEME SAFE
   ========================== */

.course-detail {
  max-width: 1100px;
  margin: 0 auto;
}

.course-header {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  background: var(--bs-body-bg);
  border: 1px solid var(--bs-border-color);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--bs-box-shadow);
}

.course-image-wrap {
  flex: 0 0 360px;
  max-width: 360px;
  background: var(--bs-secondary-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 12px;
}

.course-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.course-image.logo {
  object-fit: contain;
  padding: 12px;
}

.course-header-content {
  flex: 1;
  padding: 24px;
  color: var(--bs-body-color);
}

.course-title {
  font-size: 1.75rem;
  font-weight: 700;
}

.course-description {
  color: var(--bs-secondary-color);
}

.progress {
  height: 10px;
}

.list-group-item h5 {
  font-size: 1rem;
  font-weight: 600;
}

.lesson-description {
  font-size: 0.9rem;
  color: var(--bs-secondary-color);
}

@media (max-width: 768px) {
  .course-header { flex-direction: column; }
  .course-image-wrap { max-width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<div class="course-detail">

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{{ url_for('user_dashboard') }}">Dashboard</a>
    </li>
    <li class="breadcrumb-item active">{{ course.title }}</li>
  </ol>
</nav>

{% set placeholder = url_for('static', filename='img/course-placeholder.svg') %}

<!-- HEADER -->
<div class="course-header mb-4">
  <div class="course-image-wrap">
    <img src="{{ course.cover_image_url or placeholder }}"
         class="course-image"
         alt="{{ course.title }}">
  </div>

  <div class="course-header-content">
    <div class="d-flex justify-content-between align-items-start">
      <h1 class="course-title">{{ course.title }}</h1>
      {% if is_mandatory %}
        <span class="badge bg-danger">Mandatory</span>
      {% endif %}
    </div>

    <p class="course-description">{{ course.description }}</p>
    <small class="text-muted">
      Last updated: {{ course.updated_at.strftime('%d %b, %Y') }}
    </small>

    {% if course.interests %}
    <div class="mt-3">
      {% for interest in course.interests %}
        <span class="badge bg-primary bg-opacity-25 text-primary me-1">
          {{ interest.name }}
        </span>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<!-- PROGRESS -->
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between mb-2">
      <strong>Your Progress</strong>
      <span class="badge bg-primary">
        {{ course_progress.completed }}/{{ course_progress.total }} lessons
      </span>
    </div>

    <div class="progress">
      <div class="progress-bar"
           style="width: {{ course_progress.percentage }}%">
        {{ course_progress.percentage }}%
      </div>
    </div>
  </div>
</div>

<!-- COURSE CONTENT -->
<h2 class="section-title mb-3">Course Content</h2>

<div class="card mb-4">
  <div class="list-group list-group-flush">
    {% for lesson in lessons %}
    <a href="{{ url_for('view_lesson', lesson_id=lesson.id) }}"
       class="list-group-item list-group-item-action">

      <div class="d-flex justify-content-between align-items-center">
        <h5>{{ lesson.order }}. {{ lesson.title }}</h5>

        {% if lesson_progress.get(lesson.id) == 'completed' %}
          <span class="badge bg-success">Completed</span>
        {% elif lesson_progress.get(lesson.id) == 'in_progress' %}
          <span class="badge bg-warning text-dark">In Progress</span>
        {% endif %}
      </div>

      {% if lesson.description %}
        <div class="lesson-description mt-1">
          {{ lesson.description|truncate(140) }}
        </div>
      {% endif %}
    </a>
    {% endfor %}
  </div>
</div>

<!-- Final Assignment Section -->
    {% if course_assignment and course_assignment.questions.count() > 0 %}
<div class="card mt-4" style="border: 2px solid {% if assignment_passed %}#1e1e2d{% else %}#1e1e2d{% endif %};">
  <div class="card-header" style="background: {% if assignment_passed %}linear-gradient(90deg, var(--bs-success), #20c997){% else %}linear-gradient(90deg, var(--bs-primary), #4ea1ff){% endif %}; color: #fff;">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="mb-0">
        <i class="fas fa-{% if assignment_passed %}trophy{% else %}clipboard-check{% endif %} me-2"></i>
        Final Assessment: {{ course_assignment.title }}
      </h4>
      {% if assignment_passed %}
      <span class="badge bg-light text-success fs-6" style="background-color: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.06);">
        <i class="fas fa-check-circle me-1"></i> Passed
      </span>
      {% elif assignment_score is not none %}
      <span class="badge bg-light text-danger fs-6" style="background-color: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.06);">
        <i class="fas fa-times-circle me-1"></i> Not Passed ({{ assignment_score }}%)
      </span>
      {% endif %}
    </div>
  </div>
        <div class="card-body">
            {% if course_assignment.description %}
            <p class="mb-3">{{ course_assignment.description }}</p>
            {% endif %}
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-percentage text-primary me-2"></i>
                        <span><strong>Passing Score:</strong> {{ course_assignment.passing_score }}%</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-question-circle text-info me-2"></i>
                        <span><strong>Questions:</strong> {{ course_assignment.questions.count() }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock text-warning me-2"></i>
                        <span><strong>Time Limit:</strong> {% if course_assignment.time_limit_minutes %}{{ course_assignment.time_limit_minutes }} min{% else %}No limit{% endif %}</span>
                    </div>
                </div>
            </div>

            {% if assignment_passed %}
            <div class="alert alert-success mb-3">
                <i class="fas fa-trophy me-2"></i>
                <strong>Congratulations!</strong> You have passed this assessment with a score of {{ assignment_score }}%. 
                You have successfully completed this course!
            </div>
            {% elif course_progress.percentage < 100 %}
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Complete all lessons before taking the final assessment.
            </div>
            {% endif %}

            <div class="text-center">
                {% if assignment_passed %}
                <a href="{{ url_for('start_assignment', assignment_id=course_assignment.id) }}" class="btn btn-outline-success btn-lg">
                    <i class="fas fa-redo me-2"></i> Retake Assessment
                </a>
                {% elif course_progress.percentage == 100 %}
                <a href="{{ url_for('start_assignment', assignment_id=course_assignment.id) }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-play me-2"></i> Take Final Assessment
                </a>
                {% else %}
                <button class="btn btn-secondary btn-lg" disabled>
                    <i class="fas fa-lock me-2"></i> Complete All Lessons First
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif course_assignment %}
    <div class="card mt-4 border-secondary">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0">
                <i class="fas fa-clipboard-check me-2"></i>
                Final Assessment: {{ course_assignment.title }}
            </h4>
        </div>
        <div class="card-body text-center py-4">
            <i class="fas fa-hourglass-half fa-3x text-muted mb-3"></i>
            <h5>Assessment Coming Soon</h5>
            <p class="text-muted mb-0">The questions for this assessment are being prepared. Please check back later.</p>
        </div>
    </div>
    {% endif %}

<!-- CERTIFICATE -->
{% if is_completed and course.issue_certificates %}
<div class="card mb-4">
  <div class="card-body text-center">
    <h5><i class="fas fa-certificate me-2"></i>Certificate Available</h5>
    <a href="{{ url_for('download_certificate', course_id=course.id) }}"
       class="btn btn-success">
      Download Certificate
    </a>
  </div>
</div>
{% endif %}

</div>
{% endblock %}
