{% extends "base.html" %}

{% block styles %}
<style>
/* --- Two-column course header layout --- */
.course-detail {
  max-width: 1100px;
  margin: 0 auto;
}

/* row layout: left image, right text */
.course-header {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  align-items: stretch;
  background: #15171b;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 20px rgba(5,9,15,0.6);
}

/* image container (left column) */
.course-image-wrap {
  flex: 0 0 360px;
  max-width: 360px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #0b1220;
  padding: 12px;
  box-sizing: border-box;
}

.course-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.course-image.logo {
  object-fit: contain;
  padding: 12px;
  width: auto;
  max-width: 100%;
  max-height: 100%;
  background: transparent;
}

/* right column (content) */
.course-header-content {
  flex: 1;
  padding: 24px;
  color: #d9e1ea;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.course-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: #fff;
  margin-bottom: 12px;
}

.course-description {
  color: rgba(255,255,255,0.75);
  margin-bottom: 16px;
}

/* badge and small info */
.course-header-content small {
  color: rgba(255,255,255,0.6);
}

/* responsiveness */
@media (max-width: 768px) {
  .course-header {
    flex-direction: column;
  }
  .course-image-wrap {
    width: 100%;
    max-width: 100%;
    flex: 1 1 auto;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="section course-detail">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('user_dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ course.title }}</li>
        </ol>
    </nav>

    {# Placeholder for fallback #}
    {% set placeholder = url_for('static', filename='img/course-placeholder.svg') %}
    {% set tmp_url = (course.cover_image_url or '') | lower %}
    {% if '?' in tmp_url %}
        {% set tmp_url = tmp_url[:tmp_url.find('?')] %}
    {% endif %}
    {% set is_logo = course.cover_image_url and (tmp_url.endswith('.svg') or tmp_url.endswith('.png') or tmp_url.endswith('.jpg') or tmp_url.endswith('.jpeg')) %}

    <!-- Two-column header -->
    <div class="course-header mb-4">
        <div class="course-image-wrap">
            <img
                src="{{ course.cover_image_url or placeholder }}"
                alt="{{ (course.title ~ ' â€” course cover') | e }}"
                class="course-image {{ 'logo' if is_logo else '' }}"
                loading="lazy"
                decoding="async"
                onerror="(function(i,p){ if(i.src===p) return; i.onerror=null; i.src=p; })(this,'{{ placeholder }}');" />
        </div>

        <div class="course-header-content">
            <div class="d-flex justify-content-between align-items-start">
                <h1 class="course-title">{{ course.title }}</h1>
                {% if is_mandatory %}
                <span class="badge bg-danger" style="font-size: 0.85rem; padding: 0.5rem 0.75rem;">
                    <i class="fas fa-exclamation-circle me-1"></i>Mandatory Course
                </span>
                {% endif %}
            </div>

            {% if course.is_thbs_restricted() %}
            <div class="alert alert-warning d-flex align-items-start mb-3">
                <i class="fas fa-lock me-2 mt-1"></i>
                <div>
                    <strong>Domain Restricted Content</strong><br>
                    <strong>This course contains advanced Erlang-L3 content accessible only to THBS domain users.</strong>
                </div>
            </div>
            {% endif %}

            <p class="course-description">{{ course.description }}</p>
            <p><small>Last updated: {{ course.updated_at.strftime('%d %b, %Y') }}</small></p>

            <div class="mt-3">
                <h5>Topics covered:</h5>
                <div class="mb-3">
                    {% for interest in course.interests %}
                    <span class="badge bg-primary me-1">{{ interest.name }}</span>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2"> 
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Your Progress</h5>
                <span class="badge bg-primary fs-6">{{ course_progress.completed }}/{{ course_progress.total }} lessons</span>
            </div>
            
                    {% set pct = course_progress.percentage|round|int %}

                    <div class="progress progress-compact" aria-label="Course progress">
                    <div class="progress-bar progress-bar-contrast"
                        role="progressbar"
                        style="width: {{ pct }}%;"
                        aria-valuenow="{{ pct }}"
                        aria-valuemin="0"
                        aria-valuemax="100">
                        {{ pct }}%
                    </div>
                    </div>
            {% if course_progress.percentage == 100 %}
            <div class="alert alert-success mt-3 mb-0 d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-trophy me-2"></i> Congratulations! You have completed this course!
                </div>
                {% if course.issue_certificates %}
                <a href="{{ url_for('download_certificate', course_id=course.id) }}" class="btn btn-success btn-sm">
                    <i class="fas fa-certificate me-1"></i> Download Certificate
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="section-title mb-0">Course Content</h2>
    </div>

    {% if not lessons %}
    <div class="alert alert-info">
        <h5><i class="fas fa-info-circle"></i> No content available</h5>
        <p>This course doesn't have any lessons added yet. Please check back later or contact an administrator.</p>
        <p><small class="text-muted">Course created: {{ course.created_at.strftime('%d %b, %Y') }}</small></p>
    </div>
    {% else %}
    <div class="card">
        <div class="card-body">
            <div class="list-group">
                {% for lesson in lessons %}
                <a href="{{ url_for('view_lesson', lesson_id=lesson.id) }}" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if lesson_progress.get(lesson.id) == 'completed' %}
                            <span class="text-success me-3" title="Completed"><i class="fas fa-check-circle fa-lg"></i></span>
                            {% elif lesson_progress.get(lesson.id) == 'in_progress' %}
                            <span class="text-warning me-3" title="In Progress"><i class="fas fa-clock fa-lg"></i></span>
                            {% else %}
                            <span class="text-muted me-3" title="Not Started"><i class="far fa-circle fa-lg"></i></span>
                            {% endif %}
                            <h5 class="mb-0">{{ lesson.order }}. {{ lesson.title }}</h5>
                        </div>
                        <div class="d-flex align-items-center">
                            {% if lesson_progress.get(lesson.id) == 'completed' %}
                            <span class="badge bg-success me-2">Completed</span>
                            {% elif lesson_progress.get(lesson.id) == 'in_progress' %}
                            <span class="badge bg-warning text-dark me-2">In Progress</span>
                            {% endif %}
                            <small class="text-muted">{{ lesson.duration if lesson.duration else '' }}</small>
                        </div>
                    </div>
                    {% if lesson.description %}
                    <p class="mb-1 text-muted ms-5">{{ lesson.description|truncate(140) }}</p>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Final Assignment Section -->
    {% if course_assignment and course_assignment.questions.count() > 0 %}
<div class="card mt-4" style="border: 2px solid {% if assignment_passed %}#1e1e2d{% else %}#1e1e2d{% endif %};">
  <div class="card-header" style="background: {% if assignment_passed %}linear-gradient(90deg, var(--bs-success), #20c997){% else %}linear-gradient(90deg, var(--bs-primary), #4ea1ff){% endif %}; color: #fff;">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="mb-0">
        <i class="fas fa-{% if assignment_passed %}trophy{% else %}clipboard-check{% endif %} me-2"></i>
        Final Assessment: {{ course_assignment.title }}
      </h4>
      {% if assignment_passed %}
      <span class="badge bg-light text-success fs-6" style="background-color: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.06);">
        <i class="fas fa-check-circle me-1"></i> Passed
      </span>
      {% elif assignment_score is not none %}
      <span class="badge bg-light text-danger fs-6" style="background-color: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.06);">
        <i class="fas fa-times-circle me-1"></i> Not Passed ({{ assignment_score }}%)
      </span>
      {% endif %}
    </div>
  </div>
        <div class="card-body">
            {% if course_assignment.description %}
            <p class="mb-3">{{ course_assignment.description }}</p>
            {% endif %}
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-percentage text-primary me-2"></i>
                        <span><strong>Passing Score:</strong> {{ course_assignment.passing_score }}%</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-question-circle text-info me-2"></i>
                        <span><strong>Questions:</strong> {{ course_assignment.questions.count() }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock text-warning me-2"></i>
                        <span><strong>Time Limit:</strong> {% if course_assignment.time_limit_minutes %}{{ course_assignment.time_limit_minutes }} min{% else %}No limit{% endif %}</span>
                    </div>
                </div>
            </div>

            {% if assignment_passed %}
            <div class="alert alert-success mb-3">
                <i class="fas fa-trophy me-2"></i>
                <strong>Congratulations!</strong> You have passed this assessment with a score of {{ assignment_score }}%. 
                You have successfully completed this course!
            </div>
            {% elif course_progress.percentage < 100 %}
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Complete all lessons before taking the final assessment.
            </div>
            {% endif %}

            <div class="text-center">
                {% if assignment_passed %}
                <a href="{{ url_for('start_assignment', assignment_id=course_assignment.id) }}" class="btn btn-outline-success btn-lg">
                    <i class="fas fa-redo me-2"></i> Retake Assessment
                </a>
                {% elif course_progress.percentage == 100 %}
                <a href="{{ url_for('start_assignment', assignment_id=course_assignment.id) }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-play me-2"></i> Take Final Assessment
                </a>
                {% else %}
                <button class="btn btn-secondary btn-lg" disabled>
                    <i class="fas fa-lock me-2"></i> Complete All Lessons First
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif course_assignment %}
    <div class="card mt-4 border-secondary">
        <div class="card-header bg-secondary text-white">
            <h4 class="mb-0">
                <i class="fas fa-clipboard-check me-2"></i>
                Final Assessment: {{ course_assignment.title }}
            </h4>
        </div>
        <div class="card-body text-center py-4">
            <i class="fas fa-hourglass-half fa-3x text-muted mb-3"></i>
            <h5>Assessment Coming Soon</h5>
            <p class="text-muted mb-0">The questions for this assessment are being prepared. Please check back later.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- JS for auto logo detection -->
<script>
document.querySelectorAll('.course-image').forEach(img => {
  const markIfWide = () => {
    try {
      if (!img.classList.contains('logo') && img.naturalWidth && img.naturalHeight) {
        if ((img.naturalWidth / img.naturalHeight) > 2.2) img.classList.add('logo');
      }
    } catch(e){}
  };

  if (img.complete) {
    setTimeout(markIfWide, 0);
  } else {
    img.addEventListener('load', markIfWide, { once: true });
    img.addEventListener('error', () => setTimeout(markIfWide, 0), { once: true });
  }
});
</script>
{% endblock %}
